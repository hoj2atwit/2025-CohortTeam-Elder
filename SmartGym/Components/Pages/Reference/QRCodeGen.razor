@page "/qrcode"
@using SmartGym.Models
@using SmartGym.Services
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims;
@inject SmartGym.Services.IUserService service
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject QRCodeService QRService


<PageTitle>QR Code Generator</PageTitle>
<h1>QR Code</h1>
<section class="contained">
    <section class="flex min-h-[80vh] items-center justify-center">
        <!-- Button to trigger QR code generation -->
        @if (!string.IsNullOrEmpty(qrCode))
        {
            <img src="@qrCode" alt="QR Code" />
        }
    </section>
</section>

@code {

    // Variable to hold the generated QR code HTML
    private string? userName;
    private int id = 1;
    private List<string> defaultSvgs = new List<string> { "manager.svg", "staff.svg", "user.svg", "trainer.svg" };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            userName = user.Identity.Name;
            id = int.Parse(user.FindFirst(ClaimTypes.NameIdentifier)?.Value);

        }

        QRCodeGenerator();
    }

    private string qrCode = "";
    private string text = "";

    // Method to generate QR code from user input
    private void QRCodeGenerator()
    {
        //UserDto userdto = await service.GetUserById(id);
        Random random = new Random();
        long first = random.NextInt64(5000000000, 1000000000000);
        long second = random.NextInt64(5000000000, 1000000000000);
        long third = random.NextInt64(5000000000, 1000000000000);
        text = $"{navigationManager.BaseUri}QRCheckin/%{first}%{userName}${second}${id}&{third}&/";
        //Set Random ints to User DB to compare to for checkin and login.
        // Create a QR code from the input text
        try {

            if (string.IsNullOrEmpty(text))
            {
                throw new ArgumentException("Text can't be empty");
            }

            // Convert the generated QR code to HTML tag
            StateHasChanged();
            qrCode = QRService.GenerateSvgQRCode(text);
        } catch (Exception e) {
            Console.WriteLine($"Error: {e.Message}");
        }
    }
}

